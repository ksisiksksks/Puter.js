<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rafi AI - Pro</title>
    
    <script src="https://js.puter.com/v2/"></script>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 5px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        
        .hidden-screen { display: none !important; }
        
        /* Markdown Styles */
        .prose p { margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; margin-left: 1.5em; }
        .prose ol { list-style-type: decimal; margin-left: 1.5em; }
        .prose pre { background: #1f2937; padding: 10px; border-radius: 8px; overflow-x: auto; }
        .prose code { background: #374151; padding: 2px 5px; border-radius: 4px; font-family: monospace; font-size: 0.9em; }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 font-sans h-screen overflow-hidden selection:bg-blue-600">

    <div id="login-screen" class="fixed inset-0 z-50 bg-gray-900 flex flex-col items-center justify-center p-4">
        <div class="w-full max-w-md bg-gray-800 border border-gray-700 rounded-2xl p-8 shadow-2xl">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-blue-600 rounded-2xl mx-auto flex items-center justify-center shadow-lg shadow-blue-900/50 mb-4">
                    <i class="fas fa-robot text-3xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold text-white">Welcome Back</h1>
                <p class="text-gray-400 text-sm">Masuk untuk mengakses Rafi AI Pro</p>
            </div>
            
            <form onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Username</label>
                    <input type="text" id="username" required class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none transition" placeholder="Contoh: Bosku">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Password</label>
                    <input type="password" class="w-full bg-gray-900 border border-gray-700 rounded-lg p-3 text-white focus:border-blue-500 focus:outline-none transition" placeholder="• • • • • •">
                </div>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg transition shadow-lg mt-4">
                    MASUK SEKARANG
                </button>
            </form>
            <p class="text-center text-xs text-gray-600 mt-6">Simulasi Login (Password bebas)</p>
        </div>
    </div>

    <div id="app-screen" class="flex h-full hidden-screen">
        
        <div id="sidebar" class="w-64 bg-gray-950 border-r border-gray-800 flex-col hidden md:flex transition-all duration-300 absolute md:relative z-20 h-full">
            <div class="p-4 border-b border-gray-800 flex justify-between items-center">
                <h2 class="font-bold text-gray-400 text-xs uppercase tracking-wider">Riwayat Chat</h2>
                <button onclick="toggleSidebar()" class="md:hidden text-gray-400"><i class="fas fa-times"></i></button>
            </div>
            
            <div class="p-3">
                <button onclick="startNewChat()" class="w-full bg-blue-600/10 hover:bg-blue-600/20 text-blue-400 border border-blue-600/30 p-3 rounded-lg flex items-center gap-2 transition text-sm font-bold">
                    <i class="fas fa-plus"></i> Chat Baru
                </button>
            </div>

            <div id="history-list" class="flex-1 overflow-y-auto p-3 space-y-2">
                </div>

            <div class="p-4 border-t border-gray-800 bg-gray-950">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 rounded-full bg-gradient-to-tr from-blue-500 to-purple-500 flex items-center justify-center font-bold text-xs" id="user-avatar">U</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-bold text-white truncate" id="user-display-name">User</p>
                        <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300">Log Out</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex-1 flex flex-col h-full bg-gray-900 relative">
            
            <div class="h-16 border-b border-gray-800 flex items-center justify-between px-4 bg-gray-900/95 backdrop-blur z-10">
                <div class="flex items-center gap-3">
                    <button onclick="toggleSidebar()" class="md:hidden text-gray-400 hover:text-white"><i class="fas fa-bars"></i></button>
                    <div class="flex flex-col">
                        <span class="font-bold text-white flex items-center gap-2">
                            Rafi AI <span class="bg-blue-600 text-[10px] px-1.5 py-0.5 rounded text-white">PRO</span>
                        </span>
                        <span class="text-[10px] text-green-500 flex items-center gap-1">
                            <span class="w-1.5 h-1.5 rounded-full bg-green-500 animate-pulse"></span> Online
                        </span>
                    </div>
                </div>
                <button onclick="clearCurrentChat()" class="text-gray-500 hover:text-red-500 text-xs" title="Hapus Chat Ini">
                    <i class="fas fa-trash"></i>
                </button>
            </div>

            <div id="chat-container" class="flex-1 overflow-y-auto p-4 space-y-6 pb-24 scroll-smooth">
                <div class="flex flex-col items-center justify-center h-full text-gray-600 opacity-50 space-y-2">
                    <i class="fas fa-comment-dots text-4xl"></i>
                    <p class="text-sm">Mulai percakapan baru...</p>
                </div>
            </div>

            <div class="absolute bottom-0 w-full bg-gray-900 border-t border-gray-800 p-3 md:p-4">
                <div id="image-preview" class="hidden absolute bottom-full left-4 mb-2 bg-gray-800 p-2 rounded-lg border border-gray-700 shadow-xl">
                    <div class="relative">
                        <img id="preview-img" src="" class="h-20 rounded object-cover">
                        <button onclick="cancelUpload()" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center text-xs shadow-md"><i class="fas fa-times"></i></button>
                    </div>
                </div>

                <div class="max-w-4xl mx-auto flex gap-2 items-end bg-gray-800 p-2 rounded-2xl border border-gray-700 focus-within:border-blue-500 transition-colors shadow-lg">
                    <button onclick="document.getElementById('file-upload').click()" class="p-3 text-gray-400 hover:text-blue-400 transition shrink-0">
                        <i class="fas fa-paperclip"></i>
                    </button>
                    <input type="file" id="file-upload" class="hidden" accept="image/*" onchange="handleFileUpload(this)">

                    <textarea id="user-input" rows="1" class="flex-1 bg-transparent text-white placeholder-gray-500 text-sm py-3 focus:outline-none resize-none max-h-32" placeholder="Ketik pesan..."></textarea>
                    
                    <button onclick="sendMessage()" class="p-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl transition shadow-lg shrink-0">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- KONFIGURASI DAN STATE ---
        const loginScreen = document.getElementById('login-screen');
        const appScreen = document.getElementById('app-screen');
        const chatContainer = document.getElementById('chat-container');
        const userInput = document.getElementById('user-input');
        const sidebar = document.getElementById('sidebar');
        const historyList = document.getElementById('history-list');
        
        let currentUser = localStorage.getItem('rafi_user');
        let chats = JSON.parse(localStorage.getItem('rafi_chats')) || [];
        let currentChatId = null;
        let attachedImage = null; // Menyimpan base64 gambar sementara

        // --- SISTEM LOGIN ---
        function checkLogin() {
            if (currentUser) {
                loginScreen.classList.add('hidden-screen');
                appScreen.classList.remove('hidden-screen');
                document.getElementById('user-display-name').innerText = currentUser;
                document.getElementById('user-avatar').innerText = currentUser.charAt(0).toUpperCase();
                loadSidebarHistory();
                startNewChat(); // Buka chat kosong atau load terakhir
            } else {
                loginScreen.classList.remove('hidden-screen');
                appScreen.classList.add('hidden-screen');
            }
        }
        
        function handleLogin(e) {
            e.preventDefault();
            const username = document.getElementById('username').value;
            if (username) {
                currentUser = username;
                localStorage.setItem('rafi_user', currentUser);
                checkLogin();
            }
        }

        function logout() {
            localStorage.removeItem('rafi_user');
            location.reload();
        }

        // --- SISTEM HISTORY & SIDEBAR ---
        function toggleSidebar() {
            sidebar.classList.toggle('hidden');
            sidebar.classList.toggle('absolute');
            sidebar.classList.toggle('w-64');
            sidebar.classList.toggle('w-0');
        }

        function loadSidebarHistory() {
            historyList.innerHTML = '';
            // Urutkan dari yang terbaru
            const sortedChats = chats.sort((a, b) => b.timestamp - a.timestamp);
            
            sortedChats.forEach(chat => {
                const btn = document.createElement('button');
                btn.className = `w-full text-left p-3 rounded-lg text-sm mb-1 truncate transition ${chat.id === currentChatId ? 'bg-gray-800 text-white border-l-2 border-blue-500' : 'text-gray-400 hover:bg-gray-800 hover:text-white'}`;
                btn.innerText = chat.title || 'Percakapan Baru';
                btn.onclick = () => loadChat(chat.id);
                historyList.appendChild(btn);
            });
        }

        function startNewChat() {
            currentChatId = Date.now();
            // Bersihkan tampilan chat tapi JANGAN simpan ke array dulu (simpan saat pesan pertama dikirim)
            chatContainer.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full text-gray-600 opacity-50 space-y-2">
                    <i class="fas fa-robot text-4xl"></i>
                    <p class="text-sm">Halo ${currentUser}, ada yang bisa dibantu?</p>
                </div>
            `;
            // Refresh sidebar agar highlight hilang
            loadSidebarHistory(); 
            // Tutup sidebar di mobile
            if(window.innerWidth < 768) sidebar.classList.add('hidden');
        }

        function loadChat(id) {
            const chat = chats.find(c => c.id === id);
            if (!chat) return;

            currentChatId = id;
            chatContainer.innerHTML = '';
            
            chat.messages.forEach(msg => {
                appendMessageToUI(msg.role, msg.text, msg.image);
            });
            
            loadSidebarHistory(); // Update highlight
            if(window.innerWidth < 768) sidebar.classList.add('hidden');
        }

        function saveChatToStorage(role, text, image = null) {
            let chat = chats.find(c => c.id === currentChatId);
            
            if (!chat) {
                // Buat chat baru jika belum ada
                chat = {
                    id: currentChatId,
                    timestamp: Date.now(),
                    title: text.substring(0, 20) + '...', // Judul otomatis
                    messages: []
                };
                chats.push(chat);
            }

            chat.messages.push({ role, text, image });
            chat.timestamp = Date.now(); // Update waktu terakhir
            localStorage.setItem('rafi_chats', JSON.stringify(chats));
            loadSidebarHistory();
        }

        function clearCurrentChat() {
            if(confirm("Hapus percakapan ini?")) {
                chats = chats.filter(c => c.id !== currentChatId);
                localStorage.setItem('rafi_chats', JSON.stringify(chats));
                startNewChat();
            }
        }

        // --- SISTEM UPLOAD & INPUT ---
        function handleFileUpload(input) {
            const file = input.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    attachedImage = e.target.result; // Base64 string
                    document.getElementById('preview-img').src = attachedImage;
                    document.getElementById('image-preview').classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            }
        }

        function cancelUpload() {
            attachedImage = null;
            document.getElementById('file-upload').value = '';
            document.getElementById('image-preview').classList.add('hidden');
        }

        // --- CORE MESSAGING ---
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text && !attachedImage) return;

            // Jika chat container masih ada tulisan "Halo", bersihkan
            if (chatContainer.querySelector('.fa-robot')) chatContainer.innerHTML = '';

            // 1. Tampilkan & Simpan Pesan User
            const userMsgText = text;
            const userMsgImg = attachedImage;
            
            appendMessageToUI('user', userMsgText, userMsgImg);
            saveChatToStorage('user', userMsgText, userMsgImg);

            // Reset Input
            userInput.value = '';
            cancelUpload();

            // 2. Loading State
            const loadingId = showLoading();

            try {
                // 3. Persiapkan Prompt untuk AI
                // Karena Puter.js (Free) basicnya teks, kita kasih "Kode Konteks" kalau ada gambar
                let prompt = `System: Kamu adalah Rafi AI. User bernama ${currentUser}.\n`;
                
                if (userMsgImg) {
                    prompt += `[INFO SISTEM: User baru saja mengirim sebuah gambar/file, tapi kamu hanya melihat teks ini. Jika user bertanya tentang gambar itu, jawablah dengan sopan bahwa "Saya bisa melihat gambar yang kamu kirim di chat, tapi sebagai AI teks saya perlu kamu jelaskan sedikit detailnya agar saya bisa bantu analisis."]\n`;
                }
                
                prompt += `User: ${userMsgText}`;

                // 4. Kirim ke Puter.js
                const response = await puter.ai.chat(prompt);
                
                removeLoading(loadingId);
                
                let aiResponse = "";
                if (typeof response === 'object' && response.message) {
                    aiResponse = response.message.content;
                } else {
                    aiResponse = response.toString();
                }

                // 5. Tampilkan & Simpan Balasan AI
                appendMessageToUI('ai', aiResponse);
                saveChatToStorage('ai', aiResponse);

            } catch (err) {
                removeLoading(loadingId);
                appendMessageToUI('system', "Error koneksi: " + err.message);
            }
        }

        function appendMessageToUI(role, text, image = null) {
            const div = document.createElement('div');
            div.className = `flex gap-4 max-w-3xl mx-auto w-full mb-4 ${role === 'user' ? 'flex-row-reverse' : ''}`;
            
            let content = '';
            let avatar = '';

            // Render Gambar jika ada
            let imageHtml = '';
            if (image) {
                imageHtml = `<img src="${image}" class="max-w-full h-auto rounded-lg mb-2 border border-gray-600 shadow-md" style="max-height: 200px;">`;
            }

            if (role === 'ai') {
                avatar = `<div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center shrink-0 mt-1 shadow-md text-xs font-bold text-white">AI</div>`;
                content = `
                    <div class="max-w-[85%]">
                        <div class="text-[10px] text-gray-500 mb-1 ml-1">Rafi AI</div>
                        <div class="bg-gray-800 border border-gray-700 text-gray-200 p-4 rounded-2xl rounded-tl-none shadow-sm prose prose-invert prose-sm">
                            ${marked.parse(text)}
                        </div>
                    </div>`;
            } else if (role === 'user') {
                avatar = `<div class="w-8 h-8 bg-gray-700 rounded-full flex items-center justify-center shrink-0 mt-1 text-xs text-gray-300"><i class="fas fa-user"></i></div>`;
                content = `
                    <div class="max-w-[85%] flex flex-col items-end">
                        <div class="bg-blue-600 text-white p-3 rounded-2xl rounded-tr-none shadow-md text-sm">
                            ${imageHtml}
                            <p>${text.replace(/\n/g, '<br>')}</p>
                        </div>
                    </div>`;
            } else {
                content = `<div class="w-full text-center text-red-400 text-xs bg-red-900/10 p-2 rounded border border-red-900/30">${text}</div>`;
            }

            div.innerHTML = role === 'system' ? content : (role === 'user' ? content + avatar : avatar + content);
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        function showLoading() {
            const id = 'load-' + Date.now();
            const div = document.createElement('div');
            div.id = id;
            div.className = 'flex gap-4 max-w-3xl mx-auto w-full';
            div.innerHTML = `
                <div class="w-8 h-8 bg-blue-600 rounded-full flex items-center justify-center shrink-0 mt-1 text-xs text-white">AI</div>
                <div class="bg-gray-800 border border-gray-700 p-3 rounded-2xl rounded-tl-none shadow-sm flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce"></span>
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></span>
                    <span class="w-1.5 h-1.5 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></span>
                </div>
            `;
            chatContainer.appendChild(div);
            chatContainer.scrollTop = chatContainer.scrollHeight;
            return id;
        }

        // Init
        checkLogin();
    </script>
</body>
</html>
